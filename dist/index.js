#!/usr/bin/env node
"use strict";var V=Object.create;var v=Object.defineProperty;var W=Object.getOwnPropertyDescriptor;var X=Object.getOwnPropertyNames;var q=Object.getPrototypeOf,K=Object.prototype.hasOwnProperty;var L=(t,e,i,n)=>{if(e&&typeof e=="object"||typeof e=="function")for(let s of X(e))!K.call(t,s)&&s!==i&&v(t,s,{get:()=>e[s],enumerable:!(n=W(e,s))||n.enumerable});return t};var a=(t,e,i)=>(i=t!=null?V(q(t)):{},L(e||!t||!t.__esModule?v(i,"default",{value:t,enumerable:!0}):i,t));var N=require("commander"),Y=require("fs");var l=a(require("ora")),y=a(require("path")),r=a(require("chalk")),g=a(require("boxen"));var c=a(require("execa")),C=a(require("path")),R=a(require("rimraf"));function Q(t){try{return c.default.commandSync("git rev-parse --is-inside-work-tree",{stdio:"ignore",cwd:t}),!0}catch{}return!1}function Z(t){try{return c.default.commandSync("hg --cwd . root",{stdio:"ignore",cwd:t}),!0}catch{}return!1}function _(t,e){let i=!1;try{c.default.commandSync("git --version",{stdio:"ignore",cwd:t})}catch{return"git-not-found"}if(Q(t)||Z(t))return"already-in-repository";try{c.default.commandSync("git init",{stdio:"ignore",cwd:t})}catch{return"git-init-failed"}i=!0;try{c.default.commandSync("git checkout -b main",{stdio:"ignore",cwd:t}),c.default.commandSync("git add -A",{stdio:"ignore",cwd:t}),c.default.sync("git",["commit",`--message="${e}"`],{stdio:"ignore",cwd:t})}catch{if(i)try{R.default.sync(C.default.join(t,".git"))}catch{}return"git-commit-failed"}return"success"}var h=a(require("fs"));async function A(t,e={recursive:!0}){try{return h.default.existsSync(t)?"already":(await h.default.promises.mkdir(t,e),"success")}catch{return"failed"}}var P=a(require("got"));async function tt(t){return(await P.default.head(t).catch(i=>i)).statusCode===200}async function F({organization:t,repository:e,example:i,branch:n}){return tt(`https://api.github.com/repos/${t}/${e}/contents/examples/${encodeURIComponent(i)}?ref=${n}`)}var O=a(require("got")),j=a(require("tar")),T=require("stream"),E=require("util"),z=require("path"),p=require("fs"),et=(0,E.promisify)(T.Stream.pipeline),rt=".contentfry-example.temp";async function nt(t){let e=(0,z.join)(process.cwd(),`${rt}-${Date.now()}`);try{return await et(O.default.stream(t),(0,p.createWriteStream)(e)),e}catch{try{await p.promises.unlink(e)}catch{}return}}async function D({root:t,name:e,branch:i,repo:n,org:s}){let d=await nt(`https://codeload.github.com/${s}/${n}/tar.gz/${i}`);if(!d)return"download-failed";try{await j.default.x({file:d,cwd:t,strip:3,filter:o=>!!o.includes(`${n}-${i}/examples/${e}/`)})}catch{try{await p.promises.unlink(d)}catch{}return"extract-failed"}try{await p.promises.unlink(d)}catch{}return"success"}var H=a(require("execa")),U=a(require("which-pm-runs"));function x(){try{let{name:t}=(0,U.default)()||{};return t??"npm"}catch{return"npm"}}async function B(t){try{return await(0,H.default)(x(),["install"],{cwd:t,stdio:"ignore"}),!0}catch{return!1}}var b="contentfry",$="contentfry-starter",S="main";var it=async(t,e)=>{let i=x();typeof t!="string"&&((0,l.default)("You must specify an example name").fail(),console.log((0,g.default)([r.default`You can find {bold contentfry} examples at:`,"",r.default`{dim.cyan github.com/}{cyan contentfry/contentfry-starter/tree/master/examples}`].join(`
`),{title:r.default`No example provided`,titleAlignment:"center",borderStyle:"round",borderColor:"gray",padding:1,textAlignment:"center",margin:1,float:"center"})),process.exit(1));let n=y.default.resolve(e||t),s=(0,l.default)("Checking if example exists in contentfry").start();await F({organization:b,repository:$,example:t,branch:S})?s.succeed("Example found in contentfry repository"):(s.fail(`Could not locate an example named ${r.default.red(`"${t}"`)}`),console.log((0,g.default)([r.default`You can find {bold contentfry} examples at:`,"",r.default`{dim.cyan github.com/}{cyan contentfry/contentfry-starter/tree/master/examples}`].join(`
`),{title:r.default`Example not found`,titleAlignment:"center",borderStyle:"round",borderColor:"gray",padding:1,textAlignment:"center",margin:1,float:"center"})),process.exit(1));let o=n.includes(y.default.resolve(process.cwd()))?n.replace(y.default.resolve(process.cwd()),"."):n,u=(0,l.default)(`Creating directory ${r.default.cyan(o)}.`).start(),k=await A(n);k==="already"?u.warn(`Directory ${r.default.cyan(o)} already exists. Files will be overwritten.`):k==="failed"?(u.fail(`Failed to create directory ${r.default.cyan(o)}.`),process.exit(1)):u.succeed(`Directory ${r.default.cyan(o)} created.`);let w=(0,l.default)(`Downloading files for example ${r.default.cyan(t)}. This might take a moment.`).start(),I=await D({root:n,name:t,branch:S,repo:$,org:b});I==="download-failed"&&(w.fail(`Failed to download files for example ${r.default.cyan(t)}.`),process.exit(1)),I==="extract-failed"&&(w.fail(`Failed to extract files for example ${r.default.cyan(t)}.`),process.exit(1)),w.succeed(`Files downloaded and extracted for example ${r.default.cyan(t)}.`);let G=(0,l.default)("Installing packages. This might take a couple of minutes.").start();await B(n)?G.succeed("Packages installed successfully."):G.fail("Failed to install packages. You can try again manually.");let m=(0,l.default)(`Initializing Git in ${r.default.cyan(o)}.`).start(),f=_(n,"Initial commit from Create contentfry App");f==="git-not-found"&&m.warn("Git was not found in your PATH. Skipping Git initialization."),f==="already-in-repository"&&m.warn(`Directory ${r.default.cyan(o)} is already a Git repository. Skipping Git initialization.`),f==="git-init-failed"&&m.warn(`Failed to initialize Git repository in ${r.default.cyan(o)}.`),f==="git-commit-failed"&&m.warn(`Failed to commit initial commit to Git repository in ${r.default.cyan(o)}.`),f==="success"&&m.succeed("Created Git repository with initial commit.");let J=i==="yarn"?"":"run ";console.log((0,g.default)([r.default`Created {cyan ${t}} at {cyan ${o}}`,"",r.default`Start using your new {bold contentfry} display example by running:`,"",r.default`  {bold cd} {cyan ${o}}`,r.default`  {bold ${i} ${J}}{cyan contentfry}`].join(`
`),{title:r.default`{bold.green Success!}`,titleAlignment:"center",borderStyle:"round",padding:1,float:"center",margin:1,borderColor:"gray"}))},M=it;var ot=()=>{let t=JSON.parse((0,Y.readFileSync)(`${__dirname}/../package.json`,"utf8")),e=new N.Command;e.version(t.version,"-v, --version","Output the current version.").usage("<command> [options]").helpOption("-h, --help","Output usage information.").option("-s, --source <source-path>","specify a custom source of plugins").option("-b, --branch <source-git-branch>","specify a custom branch in source of plugins").option("-o, --preset <preset-name>","specify a preset to use for the project").option("-l, --lucky","use this option to generate a project with random answers").option("-e, --example <example> [destination]","get a clone of an example from the contentfry-starter repository").option("-d, --download <download>","specify a download type (zip | git) of source","zip").option("-p, --project <project-name>","specify a project type to use").option("--disable-telemetry","disable telemetry data collection").allowUnknownOption(!0).allowExcessArguments(!0).action(async(i,n)=>{try{if(n.getOptionValue("example")){M(n.getOptionValue("example"),n.args[0]);return}}catch{}}),e.parse(process.argv)};ot();
