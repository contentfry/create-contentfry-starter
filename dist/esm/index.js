#!/usr/bin/env node
import{Command as K}from"commander";import{readFileSync as L}from"fs";import c from"ora";import x from"path";import e from"chalk";import b from"boxen";import a from"execa";import F from"path";import O from"rimraf";function j(t){try{return a.commandSync("git rev-parse --is-inside-work-tree",{stdio:"ignore",cwd:t}),!0}catch{}return!1}function T(t){try{return a.commandSync("hg --cwd . root",{stdio:"ignore",cwd:t}),!0}catch{}return!1}function I(t,r){let i=!1;try{a.commandSync("git --version",{stdio:"ignore",cwd:t})}catch{return"git-not-found"}if(j(t)||T(t))return"already-in-repository";try{a.commandSync("git init",{stdio:"ignore",cwd:t})}catch{return"git-init-failed"}i=!0;try{a.commandSync("git checkout -b main",{stdio:"ignore",cwd:t}),a.commandSync("git add -A",{stdio:"ignore",cwd:t}),a.sync("git",["commit",`--message="${r}"`],{stdio:"ignore",cwd:t})}catch{if(i)try{O.sync(F.join(t,".git"))}catch{}return"git-commit-failed"}return"success"}import G from"fs";async function v(t,r={recursive:!0}){try{return G.existsSync(t)?"already":(await G.promises.mkdir(t,r),"success")}catch{return"failed"}}import E from"got";async function z(t){return(await E.head(t).catch(i=>i)).statusCode===200}async function C({organization:t,repository:r,example:i,branch:n}){return z(`https://api.github.com/repos/${t}/${r}/contents/examples/${encodeURIComponent(i)}?ref=${n}`)}import D from"got";import H from"tar";import{Stream as U}from"stream";import{promisify as B}from"util";import{join as M}from"path";import{createWriteStream as N,promises as u}from"fs";var Y=B(U.pipeline),J=".contentfry-example.temp";async function V(t){let r=M(process.cwd(),`${J}-${Date.now()}`);try{return await Y(D.stream(t),N(r)),r}catch{try{await u.unlink(r)}catch{}return}}async function R({root:t,name:r,branch:i,repo:n,org:s}){let l=await V(`https://codeload.github.com/${s}/${n}/tar.gz/${i}`);if(!l)return"download-failed";try{await H.x({file:l,cwd:t,strip:3,filter:o=>!!o.includes(`${n}-${i}/examples/${r}/`)})}catch{try{await u.unlink(l)}catch{}return"extract-failed"}try{await u.unlink(l)}catch{}return"success"}import W from"execa";import X from"which-pm-runs";function y(){try{let{name:t}=X()||{};return t??"npm"}catch{return"npm"}}async function _(t){try{return await W(y(),["install"],{cwd:t,stdio:"ignore"}),!0}catch{return!1}}var g="contentfry",w="contentfry-starter",h="main";var q=async(t,r)=>{let i=y();typeof t!="string"&&(c("You must specify an example name").fail(),console.log(b([e`You can find {bold contentfry} examples at:`,"",e`{dim.cyan github.com/}{cyan contentfry/contentfry-starter/tree/master/examples}`].join(`
`),{title:e`No example provided`,titleAlignment:"center",borderStyle:"round",borderColor:"gray",padding:1,textAlignment:"center",margin:1,float:"center"})),process.exit(1));let n=x.resolve(r||t),s=c("Checking if example exists in contentfry").start();await C({organization:g,repository:w,example:t,branch:h})?s.succeed("Example found in contentfry repository"):(s.fail(`Could not locate an example named ${e.red(`"${t}"`)}`),console.log(b([e`You can find {bold contentfry} examples at:`,"",e`{dim.cyan github.com/}{cyan contentfry/contentfry-starter/tree/master/examples}`].join(`
`),{title:e`Example not found`,titleAlignment:"center",borderStyle:"round",borderColor:"gray",padding:1,textAlignment:"center",margin:1,float:"center"})),process.exit(1));let o=n.includes(x.resolve(process.cwd()))?n.replace(x.resolve(process.cwd()),"."):n,m=c(`Creating directory ${e.cyan(o)}.`).start(),$=await v(n);$==="already"?m.warn(`Directory ${e.cyan(o)} already exists. Files will be overwritten.`):$==="failed"?(m.fail(`Failed to create directory ${e.cyan(o)}.`),process.exit(1)):m.succeed(`Directory ${e.cyan(o)} created.`);let f=c(`Downloading files for example ${e.cyan(t)}. This might take a moment.`).start(),S=await R({root:n,name:t,branch:h,repo:w,org:g});S==="download-failed"&&(f.fail(`Failed to download files for example ${e.cyan(t)}.`),process.exit(1)),S==="extract-failed"&&(f.fail(`Failed to extract files for example ${e.cyan(t)}.`),process.exit(1)),f.succeed(`Files downloaded and extracted for example ${e.cyan(t)}.`);let k=c("Installing packages. This might take a couple of minutes.").start();await _(n)?k.succeed("Packages installed successfully."):k.fail("Failed to install packages. You can try again manually.");let p=c(`Initializing Git in ${e.cyan(o)}.`).start(),d=I(n,"Initial commit from Create contentfry App");d==="git-not-found"&&p.warn("Git was not found in your PATH. Skipping Git initialization."),d==="already-in-repository"&&p.warn(`Directory ${e.cyan(o)} is already a Git repository. Skipping Git initialization.`),d==="git-init-failed"&&p.warn(`Failed to initialize Git repository in ${e.cyan(o)}.`),d==="git-commit-failed"&&p.warn(`Failed to commit initial commit to Git repository in ${e.cyan(o)}.`),d==="success"&&p.succeed("Created Git repository with initial commit.");let P=i==="yarn"?"":"run ";console.log(b([e`Created {cyan ${t}} at {cyan ${o}}`,"",e`Start using your new {bold contentfry} display example by running:`,"",e`  {bold cd} {cyan ${o}}`,e`  {bold ${i} ${P}}{cyan dev}`].join(`
`),{title:e`{bold.green Success!}`,titleAlignment:"center",borderStyle:"round",padding:1,float:"center",margin:1,borderColor:"gray"}))},A=q;var Q=()=>{let t=JSON.parse(L(`${__dirname}/../package.json`,"utf8")),r=new K;r.version(t.version,"-v, --version","Output the current version.").usage("<command> [options]").helpOption("-h, --help","Output usage information.").option("-s, --source <source-path>","specify a custom source of plugins").option("-b, --branch <source-git-branch>","specify a custom branch in source of plugins").option("-o, --preset <preset-name>","specify a preset to use for the project").option("-l, --lucky","use this option to generate a project with random answers").option("-e, --example <example> [destination]","get a clone of an example from the contentfry-starter repository").option("-d, --download <download>","specify a download type (zip | git) of source","zip").option("-p, --project <project-name>","specify a project type to use").option("--disable-telemetry","disable telemetry data collection").allowUnknownOption(!0).allowExcessArguments(!0).action(async(i,n)=>{try{if(n.getOptionValue("example")){A(n.getOptionValue("example"),n.args[0]);return}}catch{}}),r.parse(process.argv)};Q();
